<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Securing A Linux Server</title>

<link rel="preload" as="font" href="/assets/fonts/inter.woff2" crossorigin>


<link rel="stylesheet" href="/assets/css/style.css?v=0364f34ca9bd710c9cf7a76d190ffebe">

<link rel="stylesheet" href="/assets/css/syntax.css?v=ed3aa5230aa0e6e4086d50a418c5d647">


<script async data-goatcounter="https://stats.kenhv.com/gc" src="/assets/js/gc.js"></script>

<link rel="icon" type="image/x-icon" sizes="16x16 24x24 32x32 48x48" href="/favicon.ico?v=2">
<link rel="icon" type="image/png" sizes="192x192" href="/favicon.png?v=2">
<link rel="apple-touch-icon" sizes="192x192" href="/favicon.png?v=2"><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Securing A Linux Server" />
<meta name="author" content="Ken Harris" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A guide to secure and harden a Linux server install." />
<meta property="og:description" content="A guide to secure and harden a Linux server install." />
<link rel="canonical" href="https://kenhv.com/blog/securing-a-linux-server" />
<meta property="og:url" content="https://kenhv.com/blog/securing-a-linux-server" />
<meta property="og:site_name" content="Ken Harris" />
<meta property="og:image" content="https://kenhv.com/assets/images/og/posts/securing-a-linux-server.png" />
<meta property="og:image:height" content="600" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:alt" content="Securing A Linux Server" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-08-28T00:00:00+05:30" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://kenhv.com/assets/images/og/posts/securing-a-linux-server.png" />
<meta name="twitter:image:alt" content="Securing A Linux Server" />
<meta property="twitter:title" content="Securing A Linux Server" />
<meta name="twitter:site" content="@KensurHV" />
<meta name="twitter:creator" content="@KensurHV" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ken Harris","url":"https://kenhv.com"},"dateModified":"2024-08-28T23:28:50+05:30","datePublished":"2024-08-28T00:00:00+05:30","description":"A guide to secure and harden a Linux server install.","headline":"Securing A Linux Server","image":{"width":1200,"height":600,"alt":"Securing A Linux Server","url":"https://kenhv.com/assets/images/og/posts/securing-a-linux-server.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kenhv.com/blog/securing-a-linux-server"},"url":"https://kenhv.com/blog/securing-a-linux-server"}</script>
<!-- End Jekyll SEO tag -->
<link rel="alternate" type="application/atom+xml" title="Feed" href="https://kenhv.com/feed.xml"></head>

<body><header>
    <nav>
        <span>
            <a href="/">Ken Harris</a>
        </span>
        <span>
            <a href="/blog">Blog</a>
            <svg xmlns="http://www.w3.org/2000/svg" class="dark-mode-button" id="dark-mode-on" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="#121212" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16.8 11.2c.8-.9 1.2-2 1.2-3.2a6 6 0 0 0-9.3-5M2 2l20 20M6.3 6.3a4.67 4.67 0 0 0 1.2 5.2c.7.7 1.3 1.5 1.5 2.5m0 4h6m-5 4h4"></path>
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="dark-mode-button" id="dark-mode-off" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5m0 4h6m-5 4h4"></path>
            </svg>
        </span>
    </nav>
    <hr>
</header><main aria-label="Content">
        <hgroup>
  <h1>Securing A Linux Server</h1>
  <p class="post-date">
    <time datetime="2024-08-28T00:00:00+05:30">
      28 August 2024</time>
    
  </p>
</hgroup>

<details>
  <summary>Table of Contents</summary>
  <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#ssh">SSH</a></li>
<li class="toc-entry toc-h2"><a href="#firewall">Firewall</a></li>
<li class="toc-entry toc-h2"><a href="#nginx">Nginx</a></li>
<li class="toc-entry toc-h2"><a href="#fail2ban">Fail2Ban</a></li>
</ul>
</details>


<article>
  <h2 id="ssh">
  
  
    SSH <a href="#ssh" class="anchor" aria-hidden="true" tabindex="-1">#</a>
  
  
</h2>
    

<p>Follow the <a href="https://ssh-audit.com/hardening_guides.html" target="_blank" rel="noopener">SSH Hardening Guide</a> for both the client and the server. This is something you should be doing on all your machines. You can skip the “connection rate throttling” section.</p>

<p>Generate an Ed25519 key:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> ed25519
</code></pre></div></div>

<p>Copy the key to your server:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-copy-id <span class="nt">-i</span> &lt;path-to-key&gt; &lt;user&gt;@&lt;ip&gt;
</code></pre></div></div>

<p>Paste the following at the end of <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code> on your server:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MaxAuthTries</span> <span class="m">3</span>
<span class="n">PermitRootLogin</span> <span class="n">no</span>
<span class="n">PasswordAuthentication</span> <span class="n">no</span>
<span class="n">PubkeyAuthentication</span> <span class="n">yes</span>
<span class="n">AuthenticationMethods</span> <span class="n">publickey</span>
<span class="n">KbdInteractiveAuthentication</span> <span class="n">no</span>
<span class="n">X11Forwarding</span> <span class="n">no</span>
</code></pre></div></div>

<p>You can change the SSH port to a random number in the same file. Finally, run the following command to restart the SSH daemon:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl restart ssh
</code></pre></div></div>
<h2 id="firewall">
  
  
    Firewall <a href="#firewall" class="anchor" aria-hidden="true" tabindex="-1">#</a>
  
  
</h2>
    

<p>Make sure the required packages are installed:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>iptables ipset ufw cron curl wget <span class="nt">-y</span>
</code></pre></div></div>

<p>Allow the SSH port and enable UFW:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>ufw allow &lt;port&gt;/tcp comment <span class="s2">"OpenSSH"</span>
<span class="nb">sudo </span>ufw <span class="nb">enable</span>
</code></pre></div></div>

<p>I also like to disable UFW logging. <strong>Do not</strong> do this unless you know what you’re doing: <code class="language-plaintext highlighter-rouge">sudo ufw logging off</code>.</p>

<p>Next up, we’ll be blocking known bad IPs using a script and a cronjob. We’ll be using <a href="https://github.com/stamparm/ipsum" target="_blank" rel="noopener">IPsum</a>, a regularly updated list. The script we’ll be using is from <a href="https://gist.github.com/arter97/2b71e193700ab002c75d1e5a0e7da6dc" target="_blank" rel="noopener">arter97</a>.</p>

<p>Download the script and run it once:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>wget https://gist.githubusercontent.com/arter97/2b71e193700ab002c75d1e5a0e7da6dc/raw/firewall.sh <span class="nt">-O</span> /opt/firewall.sh
<span class="nb">sudo chmod </span>755 /opt/firewall.sh
<span class="nb">sudo</span> /opt/firewall.sh
</code></pre></div></div>

<p>Check the output of <code class="language-plaintext highlighter-rouge">sudo dmesg</code> to verify that everything is working. Add a cronjob by running <code class="language-plaintext highlighter-rouge">sudo crontab -e</code> and paste the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@reboot /opt/firewall.sh
0 5 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /opt/firewall.sh
</code></pre></div></div>
<h2 id="nginx">
  
  
    Nginx <a href="#nginx" class="anchor" aria-hidden="true" tabindex="-1">#</a>
  
  
</h2>
    

<p>Nginx is my preferred reverse-proxy. There are a few things you can configure to improve security.</p>

<p>Add the following lines to your <code class="language-plaintext highlighter-rouge">server</code> blocks:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add_header</span> <span class="n">X</span>-<span class="n">Content</span>-<span class="n">Type</span>-<span class="n">Options</span> <span class="s2">"nosniff"</span>;
<span class="n">add_header</span> <span class="n">X</span>-<span class="n">XSS</span>-<span class="n">Protection</span> <span class="s2">"1; mode=block"</span>;
<span class="n">add_header</span> <span class="n">X</span>-<span class="n">Frame</span>-<span class="n">Options</span> <span class="s2">"SAMEORIGIN"</span>;
</code></pre></div></div>

<p>To implement Nginx Proxy Manager’s (not to be confused with Nginx) “block common exploits” functionality, do the following. Download the config file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>wget https://raw.githubusercontent.com/NginxProxyManager/nginx-proxy-manager/develop/docker/rootfs/etc/nginx/conf.d/include/block-exploits.conf <span class="nt">-O</span> /etc/nginx/block-exploits.conf
</code></pre></div></div>

<p>Then add the following line to your <code class="language-plaintext highlighter-rouge">server</code> blocks:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include</span> <span class="n">block</span>-<span class="n">exploits</span>.<span class="n">conf</span>
</code></pre></div></div>

<p>To avoid getting indexed by search engines, add the following lines to your <code class="language-plaintext highlighter-rouge">server</code> blocks:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add_header</span> <span class="n">X</span>-<span class="n">Robots</span>-<span class="n">Tag</span> <span class="s2">"noindex, nofollow, nosnippet, noarchive"</span>;
<span class="n">location</span> /<span class="n">robots</span>.<span class="n">txt</span> { <span class="n">return</span> <span class="m">200</span> <span class="s2">"User-agent: *\nDisallow: /\n"</span>; }
</code></pre></div></div>

<p>Keep in mind that inheritance works differently in Nginx for array directives such as <code class="language-plaintext highlighter-rouge">add_header</code> and <code class="language-plaintext highlighter-rouge">proxy_set_header</code>. If you have any array directives in the block above, you need to <strong>re-add</strong> them in the current block.</p>

<p>Incorrect config:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Incorrect
</span><span class="n">http</span> {
  <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">1</span> <span class="s2">""</span>;

  <span class="n">server</span> {
    <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">2</span> <span class="s2">""</span>;

    <span class="n">location</span> / {
      <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="n">localhost</span>:<span class="m">8080</span>/;
      <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">3</span> <span class="s2">""</span>;
    }
  }
}
</code></pre></div></div>

<p>Correct config:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Correct
</span><span class="n">http</span> {
  <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">1</span> <span class="s2">""</span>;

  <span class="n">server</span> {
    <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">1</span> <span class="s2">""</span>;
    <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">2</span> <span class="s2">""</span>;

    <span class="n">location</span> / {
      <span class="n">proxy_pass</span> <span class="n">http</span>://<span class="n">localhost</span>:<span class="m">8080</span>/;
      <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">1</span> <span class="s2">""</span>;
      <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">2</span> <span class="s2">""</span>;
      <span class="n">add_header</span> <span class="n">X</span>-<span class="n">Header</span>-<span class="m">3</span> <span class="s2">""</span>;
    }
  }
}
</code></pre></div></div>
<h2 id="fail2ban">
  
  
    Fail2Ban <a href="#fail2ban" class="anchor" aria-hidden="true" tabindex="-1">#</a>
  
  
</h2>
    

<p>Install Fail2Ban:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>fail2ban <span class="nt">-y</span>
</code></pre></div></div>

<p><strong>Do not</strong> copy <code class="language-plaintext highlighter-rouge">/etc/fail2ban/jail.conf</code> to <code class="language-plaintext highlighter-rouge">/etc/fail2ban/jail.local</code>. Most guides I’ve seen suggest doing this, but this <a href="https://github.com/fail2ban/fail2ban/wiki/Proper-fail2ban-configuration" target="_blank" rel="noopener">isn’t the right way</a>. Create <code class="language-plaintext highlighter-rouge">/etc/fail2ban/jail.local</code> with the following contents:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[DEFAULT]
bantime = 1d
findtime = 15m
maxretry = 3
backend = auto

[sshd]
port = &lt;port&gt;
</code></pre></div></div>

<p>SSH is the only jail enabled by default, so we just need to give it the correct port.</p>

<p>Fail2Ban ships with some pre-configured jails for Nginx, which you can enable by adding the following to <code class="language-plaintext highlighter-rouge">/etc/fail2ban/jail.local</code>:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">nginx</span>-<span class="n">http</span>-<span class="n">auth</span>]
<span class="n">enabled</span> = <span class="n">true</span>

[<span class="n">nginx</span>-<span class="n">bad</span>-<span class="n">request</span>]
<span class="n">enabled</span> = <span class="n">true</span>

[<span class="n">nginx</span>-<span class="n">botsearch</span>]
<span class="n">enabled</span>  = <span class="n">true</span>
</code></pre></div></div>

<p>Just make sure all your Nginx <code class="language-plaintext highlighter-rouge">location</code> blocks have the following lines to ban the correct IPs:</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">include</span> <span class="n">proxy_params</span>;
</code></pre></div></div>

<p>If you’re using Cloudflare proxy, we need to do a bit more so that Fail2Ban bans the end user’s IP and not Cloudflare IPs. Follow my blog post on <a href="https://kenhv.com/blog/fail2ban-with-nginx-and-cloudflare-ipv6">setting up Fail2Ban With Nginx and Cloudflare Free</a>.</p>

<p>That pretty much covers it. Just make sure you’re using strong and random passwords/passphrases for everything.</p>

<p>If you have any comments or suggestions, feel free to <a href="mailto:ken@kenhv.com">mail me</a>!</p>

</article>
    </main><footer>
    <hr>
    © 2024 KenHV / Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" target="_blank" rel="noopener">CC BY-NC-SA
        4.0</a>
</footer><script>
    const theme = sessionStorage.getItem("theme") ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    document.body.classList.toggle("dark-mode", theme === "dark");

    ["on", "off"].forEach(mode => {
        document.getElementById(`dark-mode-${mode}`).addEventListener("click", () => {
            document.body.classList.toggle("dark-mode", mode === "on");
            sessionStorage.setItem("theme", mode === "on" ? "dark" : "light");
        });
    });
</script></body>

</html>