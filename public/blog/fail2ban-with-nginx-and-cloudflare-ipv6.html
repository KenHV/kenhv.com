<!doctype html><html lang="en" prefix="og: http://ogp.me/ns#"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)</title><link rel="preload" as="font" href="/assets/fonts/inter.woff2" crossorigin><link rel="stylesheet" href="/assets/css/style.css?v=1723660699"><script async data-goatcounter="https://stats.kenhv.com/gc" src="/assets/js/gc.js"></script><link rel="icon" type="image/x-icon" sizes="16x16 24x24 32x32 48x48" href="/favicon.ico"><link rel="icon" type="image/png" sizes="192x192" href="/favicon.png"><link rel="apple-touch-icon" sizes="192x192" href="/favicon.png"><meta name="generator" content="Jekyll v4.3.3"/><meta property="og:title" content="Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)"/><meta name="author" content="Ken Harris"/><meta property="og:locale" content="en_US"/><meta name="description" content="A guide to set up Fail2Ban with Nginx and Cloudflare free plan with IPv6 support. Includes instructions to restore original visitor IP in Nginx."/><meta property="og:description" content="A guide to set up Fail2Ban with Nginx and Cloudflare free plan with IPv6 support. Includes instructions to restore original visitor IP in Nginx."/><link rel="canonical" href="https://kenhv.com/blog/fail2ban-with-nginx-and-cloudflare-ipv6"/><meta property="og:url" content="https://kenhv.com/blog/fail2ban-with-nginx-and-cloudflare-ipv6"/><meta property="og:site_name" content="Ken Harris"/><meta property="og:image" content="https://kenhv.com/assets/images/og/posts/fail2ban-with-nginx-and-cloudflare-ipv6.png"/><meta property="og:image:height" content="600"/><meta property="og:image:width" content="1200"/><meta property="og:image:alt" content="Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2024-08-04T00:00:00+05:30"/><meta name="twitter:card" content="summary_large_image"/><meta property="twitter:image" content="https://kenhv.com/assets/images/og/posts/fail2ban-with-nginx-and-cloudflare-ipv6.png"/><meta name="twitter:image:alt" content="Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)"/><meta property="twitter:title" content="Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)"/><meta name="twitter:site" content="@KensurHV"/><meta name="twitter:creator" content="@KensurHV"/><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Ken Harris","url":"https://kenhv.com"},"dateModified":"2024-08-11T00:00:00+05:30","datePublished":"2024-08-04T00:00:00+05:30","description":"A guide to set up Fail2Ban with Nginx and Cloudflare free plan with IPv6 support. Includes instructions to restore original visitor IP in Nginx.","headline":"Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)","image":{"width":1200,"height":600,"alt":"Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)","url":"https://kenhv.com/assets/images/og/posts/fail2ban-with-nginx-and-cloudflare-ipv6.png","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kenhv.com/blog/fail2ban-with-nginx-and-cloudflare-ipv6"},"url":"https://kenhv.com/blog/fail2ban-with-nginx-and-cloudflare-ipv6"}</script><meta property="article:modified_time" content="2024-08-11T00:00:00+05:30"/><link rel="alternate" type="application/atom+xml" title="Feed" href="https://kenhv.com/feed.xml"></head><body><header><nav><span><a href="/">Ken Harris</a> </span><span><a href="/blog">Blog</a> <svg xmlns="http://www.w3.org/2000/svg" class="dark-mode-button" id="dark-mode-on" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="#121212" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.8 11.2c.8-.9 1.2-2 1.2-3.2a6 6 0 0 0-9.3-5M2 2l20 20M6.3 6.3a4.67 4.67 0 0 0 1.2 5.2c.7.7 1.3 1.5 1.5 2.5m0 4h6m-5 4h4"></path></svg> <svg xmlns="http://www.w3.org/2000/svg" class="dark-mode-button" id="dark-mode-off" width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5m0 4h6m-5 4h4"></path></svg></span></nav><hr></header><main aria-label="Content"><hgroup><h1>Fail2Ban With Nginx and Cloudflare Free (With IPv6 Support)</h1><p class="post-date"><time datetime="2024-08-04T00:00:00+05:30">4 August 2024</time> / Updated on <time datetime="2024-08-11T00:00:00+05:30">11 August 2024</time></p></hgroup><details><summary>Table of Contents</summary><ul id="toc" class="section-nav"><li class="toc-entry toc-h2"><a href="#unmask-visitor-ip-in-nginx">Unmask Visitor IP in Nginx</a></li><li class="toc-entry toc-h2"><a href="#setup-cloudflare">Setup Cloudflare</a></li><li class="toc-entry toc-h2"><a href="#setup-fail2ban">Setup Fail2Ban</a></li><li class="toc-entry toc-h2"><a href="#setup-nginx">Setup Nginx</a></li><li class="toc-entry toc-h2"><a href="#test-your-config">Test Your Config</a></li></ul></details><article><p>This post will teach you how to set up Fail2Ban actions for services reverse-proxied by Nginx and proxied by Cloudflare. I’ll be using Vaultwarden as an example. I have Nginx and Fail2Ban installed natively, and Vaultwarden in a Docker container. You can adjust it to work with Nginx and/or Fail2Ban running in Docker containers.</p><h2 id="unmask-visitor-ip-in-nginx">Unmask Visitor IP in Nginx <a href="#unmask-visitor-ip-in-nginx" class="anchor" aria-hidden="true" tabindex="-1">#</a></h2><p>Nginx needs to know the visitor’s real IP for the ban to work. Without this step, Nginx will simply see Cloudflare IPs and let it through. Even if you’re not going to use Fail2Ban, you should set this up.</p><p>Make sure <code class="language-plaintext highlighter-rouge">jq</code> and <code class="language-plaintext highlighter-rouge">crontab</code> are installed in your system. We’ll be using a cronjob to fetch Cloudflare IPs and Nginx’s <a href="https://nginx.org/en/docs/http/ngx_http_realip_module.html" target="_blank" rel="noopener">ngx_http_realip_module</a> to unmask the IPs. The script we’re using is from <a href="https://github.com/jaapmarcus/nginx-cloudflare-real-ip/tree/use-api-instead" target="_blank" rel="noopener">this GitHub repo</a>.</p><p>Place the script somewhere on your system. I have it in <code class="language-plaintext highlighter-rouge">/opt/scripts/cloudflare.sh</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">cf_ips</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span>curl <span class="nt">-fsLm2</span> <span class="nt">--retry</span> 1 https://api.cloudflare.com/client/v4/ips<span class="si">)</span><span class="s2">"</span>
<span class="nv">CLOUDFLARE_FILE_PATH</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="p">/etc/nginx/cloudflare</span><span class="k">}</span>

<span class="nb">echo</span> <span class="s2">"# Cloudflare IP Ranges"</span> <span class="o">></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>
<span class="nb">echo</span> <span class="s2">""</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>
<span class="nb">echo</span> <span class="s2">"# - IPv4"</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>
<span class="k">for </span>ipv4 <span class="k">in</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cf_ips</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.result.ipv4_cidrs[]//""'</span> | <span class="nb">sort</span><span class="si">)</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"set_real_ip_from </span><span class="nv">$ipv4</span><span class="s2">;"</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>
<span class="k">done
</span><span class="nb">echo</span> <span class="s2">""</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>

<span class="nb">echo</span> <span class="s2">"# - IPv6"</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>
<span class="k">for </span>ipv6 <span class="k">in</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$cf_ips</span><span class="s2">"</span> | jq <span class="nt">-r</span> <span class="s1">'.result.ipv6_cidrs[]//""'</span> | <span class="nb">sort</span><span class="si">)</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"set_real_ip_from </span><span class="nv">$ipv6</span><span class="s2">;"</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>
<span class="k">done
</span><span class="nb">echo</span> <span class="s2">""</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>

<span class="nb">echo</span> <span class="s2">"real_ip_header CF-Connecting-IP;"</span> <span class="o">>></span> <span class="nv">$CLOUDFLARE_FILE_PATH</span>

nginx <span class="nt">-t</span> <span class="o">&&</span> systemctl reload nginx
</code></pre></div></div><p>Make sure the file permissions are set to <code class="language-plaintext highlighter-rouge">755</code> (<code class="language-plaintext highlighter-rouge">sudo chmod 755 /opt/scripts/cloudflare.sh</code>).</p><p>Add the following cronjob using <code class="language-plaintext highlighter-rouge">sudo crontab -e</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Sync Cloudflare IPs and reload Nginx</span>
0 4 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /opt/scripts/cloudflare.sh <span class="o">></span>/dev/null 2>&1
</code></pre></div></div><p>Add this line to the <code class="language-plaintext highlighter-rouge">http</code> block in your Nginx config <code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include /etc/nginx/cloudflare;
</code></pre></div></div><p>Now for every service you’re reverse-proxying, add this line inside <code class="language-plaintext highlighter-rouge">location</code> in the <code class="language-plaintext highlighter-rouge">server</code> block:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>include proxy_params;
</code></pre></div></div><p>Run <code class="language-plaintext highlighter-rouge">sudo nginx -t</code> to verify the config, and reload the config using <code class="language-plaintext highlighter-rouge">sudo systemctl reload nginx</code>. Nginx will now unmask the visitors’ real IP coming through Cloudflare proxy.</p><h2 id="setup-cloudflare">Setup Cloudflare <a href="#setup-cloudflare" class="anchor" aria-hidden="true" tabindex="-1">#</a></h2><p>Free Cloudflare accounts are limited to 5 WAF rules per zone. But Cloudflare offers one free <a href="https://developers.cloudflare.com/waf/tools/lists/custom-lists/" target="_blank" rel="noopener">custom list</a> that can store 10,000 IPs. This is more than enough.</p><p>Start by creating a custom list. Follow <a href="https://developers.cloudflare.com/waf/tools/lists/create-dashboard/" target="_blank" rel="noopener">these instructions</a>. You can name it whatever you want. Make sure “Type” is set to “IP”. Select “Create” and check the URL. It will be in the following format: <code class="language-plaintext highlighter-rouge">https://dash.cloudflare.com/&lt;account-id>/configurations/lists/&lt;list-id>/add</code>. Note down the values in <code class="language-plaintext highlighter-rouge">account-id</code> and <code class="language-plaintext highlighter-rouge">list-id</code>, we’ll be using this later.</p><p>We also need an API token to edit this list. Follow <a href="https://developers.cloudflare.com/fundamentals/api/get-started/create-token/" target="_blank" rel="noopener">these instructions</a>. We’ll be using a custom token. Set the permissions to “Account”, “Account Filter Lists”, and “Edit”. Note down the API token.</p><p>Next up, create a WAF rule. Follow <a href="https://developers.cloudflare.com/waf/custom-rules/create-dashboard/" target="_blank" rel="noopener">these instructions</a>. Set “Field” to “IP Source Address” and “Operator” to “is in list”. Your list should automatically be selected. Set “Action” to “Block” and “Order” to “First”. That’s your Cloudflare setup done!</p><h2 id="setup-fail2ban">Setup Fail2Ban <a href="#setup-fail2ban" class="anchor" aria-hidden="true" tabindex="-1">#</a></h2><p>Make sure <code class="language-plaintext highlighter-rouge">jp</code> is installed in your system.</p><p>The action we’re going to be using is from <a href="https://gist.github.com/Xunnamius/6057a660d06bcf13cc1f478af9131423?permalink_comment_id=5049552#gistcomment-5049552" target="_blank" rel="noopener">@sebres</a>. This supports both IPv4 and IPv6 addresses. Create <code class="language-plaintext highlighter-rouge">/etc/fail2ban/action.d/cloudflare-list.conf</code> with the following contents:</p><div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">Definition</span>]
<span class="n">actionban</span> = <span class="n">curl</span> -<span class="n">s</span> -<span class="n">o</span> /<span class="n">dev</span>/<span class="n">null</span> -<span class="n">X</span> <span class="n">POST</span> &lt;<span class="err">_</span><span class="n">cf_api_prms</span>> \
                 -<span class="n">d</span> <span class="s1">'[{"ip":"'</span><span class="s2">"&lt;cfip>"</span><span class="s1">'","comment":"Created by fail2ban &lt;name>"}]'</span> \
                 &lt;<span class="err">_</span><span class="n">cf_api_url</span>>
<span class="n">actionunban</span> = <span class="n">id</span>=$(<span class="n">curl</span> -<span class="n">s</span> -<span class="n">X</span> <span class="n">GET</span> &lt;<span class="err">_</span><span class="n">cf_api_prms</span>> \
                   <span class="s2">"&lt;_cf_api_url>?search=&lt;cfip>&per_page=1"</span> \
                   | { <span class="n">jp</span> --<span class="n">unquoted</span> <span class="s1">'result[0].id | not_null(@, `""`)'</span> <span class="m">2</span>>/<span class="n">dev</span>/<span class="n">null</span>; })
              <span class="n">if</span> [ -<span class="n">z</span> <span class="s2">"$id"</span> ]; <span class="n">then</span> <span class="n">echo</span> <span class="s2">"&lt;name>: id for &lt;ip> cannot be found"</span>; <span class="n">exit</span> <span class="m">0</span>; <span class="n">fi</span>;
              <span class="n">curl</span> -<span class="n">s</span> -<span class="n">o</span> /<span class="n">dev</span>/<span class="n">null</span> -<span class="n">X</span> <span class="n">DELETE</span> &lt;<span class="err">_</span><span class="n">cf_api_prms</span>> \
                   -<span class="n">d</span> <span class="s1">'{"items":[{"id":"'</span><span class="s2">"$id"</span><span class="s1">'"}]}'</span> \
                   &lt;<span class="err">_</span><span class="n">cf_api_url</span>>
<span class="err">_</span><span class="n">cf_api_url</span> = <span class="n">https</span>://<span class="n">api</span>.<span class="n">cloudflare</span>.<span class="n">com</span>/<span class="n">client</span>/<span class="n">v4</span>/<span class="n">accounts</span>/&lt;<span class="n">cfaccountid</span>>/<span class="n">rules</span>/<span class="n">lists</span>/&lt;<span class="n">cfbanlistid</span>>/<span class="n">items</span>
<span class="err">_</span><span class="n">cf_api_prms</span> = -<span class="n">H</span> <span class="s1">'Authorization: bearer &lt;cfapitoken>'</span> -<span class="n">H</span> <span class="s1">'Content-Type: application/json'</span>

[<span class="n">Init</span>]
<span class="n">cfip</span> = &lt;<span class="n">ip</span>>

[<span class="n">Init</span>?<span class="n">family</span>=<span class="n">inet6</span>]
<span class="n">cfip</span> = $(<span class="n">fail2ban</span>-<span class="n">python</span> -<span class="n">c</span> <span class="s1">'import sys; from fail2ban.server.ipdns import IPAddr; a = IPAddr(sys.argv[1]+"/"+sys.argv[2]); print(str(a))'</span> <span class="s2">"&lt;ip>"</span> <span class="m">64</span>)
</code></pre></div></div><p>Now create <code class="language-plaintext highlighter-rouge">/etc/fail2ban/action.d/cloudflare-list.local</code> with the following contents:</p><div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">Init</span>]
<span class="n">cfapitoken</span> = &lt;<span class="n">api</span>-<span class="n">token</span>>
<span class="n">cfaccountid</span> = &lt;<span class="n">account</span>-<span class="n">id</span>>
<span class="n">cfbanlistid</span> = &lt;<span class="n">list</span>-<span class="n">id</span>>
</code></pre></div></div><p>Fill in the details, and <strong>make sure</strong> you set the file’s permissions to <code class="language-plaintext highlighter-rouge">640</code> (<code class="language-plaintext highlighter-rouge">sudo chmod 640 /etc/fail2ban/action.d/cloudflare-list.local</code>) to ensure only <em>root</em> can read this file.</p><p>Let’s configure Fail2Ban for Vaultwarden. <a href="https://github.com/dani-garcia/vaultwarden/wiki/Logging" target="_blank" rel="noopener">Enable logging</a> in Vaultwarden. Create <code class="language-plaintext highlighter-rouge">/etc/fail2ban/filter.d/vaultwarden.local</code> with the following contents:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[INCLUDES]
before = common.conf

[Definition]
failregex = ^.*?Username or password is incorrect\. Try again\. IP: &lt;ADDR>\. Username:.*$
ignoreregex =
</code></pre></div></div><p>Now create <code class="language-plaintext highlighter-rouge">/etc/fail2ban/jail.d/vaultwarden.local</code> with the following contents:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[vaultwarden]
enabled = true
filter = vaultwarden
backend = auto
logpath = &lt;path/to/vaultwarden.log>
action = cloudflare-list
         nginx-block-map
maxretry = 3
bantime = 1d
findtime = 15m
</code></pre></div></div><p>Depending on your config, you might want to set <a href="https://github.com/dani-garcia/vaultwarden/wiki/Fail2Ban-Setup#note-for-docker-users" target="_blank" rel="noopener">chain = FORWARD</a>. Note that we’re not banning the IP using firewall rules, because we’ll be receiving requests from Cloudflare’s IPs.</p><h2 id="setup-nginx">Setup Nginx <a href="#setup-nginx" class="anchor" aria-hidden="true" tabindex="-1">#</a></h2><p>Add the following line to the <code class="language-plaintext highlighter-rouge">http</code> block in your main Nginx config (<code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code>):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>map $remote_addr $ip_blacklisted { include blacklisted-sessions.map; }
</code></pre></div></div><p>Add the following line to the <code class="language-plaintext highlighter-rouge">server</code> block of services you’re reverse-proxying:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ($ip_blacklisted) { return 444; }
</code></pre></div></div><p>The non-standard return code 444 closes a connection without sending a response header. You can also return 403 if you like.</p><h2 id="test-your-config">Test Your Config <a href="#test-your-config" class="anchor" aria-hidden="true" tabindex="-1">#</a></h2><p>To verify if everything is working, go to your Vaultwarden instance and try logging in with incorrect credentials 3 times. Check <code class="language-plaintext highlighter-rouge">/var/log/fail2ban.log</code> (<code class="language-plaintext highlighter-rouge">sudo tail -f /var/log/fail2ban.log</code>), it should say that your IP has been banned. Without reloading your Vaultwarden web vault page, try logging in with the correct credentials. It won’t work, as Nginx will only return 403. If you reload the page, Cloudflare will say you’ve been banned. To unban yourself, run <code class="language-plaintext highlighter-rouge">sudo fail2ban-client set vaultwarden unbanip &lt;banned-ip></code>. Congrats! You have secured your Vaultwarden instance with two layers of protection using Fail2Ban.</p></article></main><footer><hr>© 2024 KenHV / Licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></footer><script>const theme=sessionStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.body.classList.toggle("dark-mode","dark"===theme),["on","off"].forEach((e=>{document.getElementById(`dark-mode-${e}`).addEventListener("click",(()=>{document.body.classList.toggle("dark-mode","on"===e),sessionStorage.setItem("theme","on"===e?"dark":"light")}))}))</script></body></html>